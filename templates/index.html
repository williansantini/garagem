<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status da Garagem</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#007bff"/>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f0f0f0; padding: 10px; }
        #status-box { margin-top: 20px; padding: 30px; border-radius: 10px; text-align: center; color: white; width: 90%; max-width: 400px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .ocupada { background-color: #dc3545; }
        .livre { background-color: #28a745; }
        h1 { margin: 0; font-size: 1.8em; }
        p { margin-top: 5px; font-size: 0.9em; word-wrap: break-word; }
        #actions { margin-top: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 500px;}
        button { padding: 20px; font-size: 1em; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.1s ease; }
        button:active { transform: scale(0.95); }
        .eu-audi { background-color: #007bff; color: white; }
        .angelica-audi { background-color: #17a2b8; color: white; }
        .angelica-fit { background-color: #ffc107; color: black; }
        .nicolas-fit { background-color: #6c757d; color: white; }
        .saida { background-color: #fd7e14; color: white; grid-column: 1 / -1; }

        /* --- Estilos dos Modais --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: none; justify-content: center;
            align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 10px;
            width: 90%; max-width: 400px; text-align: center;
        }
        .modal-content h3 { margin-top: 0; margin-bottom: 20px; }
        .modal-actions button { width: 100%; margin-bottom: 10px; }
        .modal-actions button:last-child { margin-bottom: 0; }
        .btn-close { background-color: #6c757d; color: white; margin-top: 15px; }
        .btn-force-occupy { background-color: #ffc107; color: black; }
    </style>
</head>
<body>

    <div id="status-box">
        <h1 id="status-text">Carregando...</h1>
        <p id="status-details"></p>
    </div>

    <div id="actions">
        <button class="eu-audi" onclick="tryToOccupy('Willian', 'Audi')">Willian (Audi)</button>
        <button class="nicolas-fit" onclick="tryToOccupy('Nicolas', 'Fit')">Nicolas (Fit)</button>
        <button class="angelica-audi" onclick="tryToOccupy('Angelica', 'Audi')">Angelica (Audi)</button>
        <button class="angelica-fit" onclick="tryToOccupy('Angelica', 'Fit')">Angelica (Fit)</button>
        <button class="saida" onclick="openSaidaModal()">Liberei a Garagem</button>
    </div>

    <div id="saida-modal" class="modal-overlay" onclick="closeSaidaModal()">
        <div class="modal-content" onclick="event.stopPropagation();">
            <h3>Quem está saindo?</h3>
            <div class="modal-actions">
                <button class="eu-audi" onclick="confirmarSaida('Willian')">Willian</button>
                <button class="angelica-audi" onclick="confirmarSaida('Angelica')">Angelica</button>
                <button class="nicolas-fit" onclick="confirmarSaida('Nicolas')">Nicolas</button>
                <button class="btn-close" onclick="closeSaidaModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="warning-modal" class="modal-overlay" onclick="closeWarningModal()">
        <div class="modal-content" onclick="event.stopPropagation();">
            <h3 id="warning-modal-text">A vaga já está ocupada.</h3>
            <div class="modal-actions">
                <button id="force-occupy-btn" class="btn-force-occupy">Liberar e Ocupar</button>
                <button class="btn-close" onclick="closeWarningModal()">Voltar</button>
            </div>
        </div>
    </div>

    <div style="margin-top: 20px; text-align: center;">
        <button id="notifications-btn" style="padding: 15px; font-size: 1em; background-color: #333; color: white; border: none; border-radius: 8px;">
            Ativar Notificações
        </button>
    </div>

    <script>
        const statusBox = document.getElementById('status-box');
        const statusText = document.getElementById('status-text');
        const statusDetails = document.getElementById('status-details');
        const saidaModal = document.getElementById('saida-modal');
        const warningModal = document.getElementById('warning-modal');
        let currentStatus = {}; // Variável global para guardar o status atual

        // Função principal para desenhar o status na tela
        function updateStatusDisplay(data) {
            currentStatus = data; // Atualiza o status global
            statusText.textContent = `GARAGEM ${data.status}`;
            if (data.status === 'OCUPADA') {
                statusDetails.textContent = `Por ${data.pessoa} com o ${data.carro} desde ${data.timestamp}`;
                statusBox.className = 'ocupada';
            } else {
                statusDetails.textContent = `Liberada por último por ${data.pessoa} em ${data.timestamp}`;
                statusBox.className = 'livre';
            }
        }

        // Função que envia a atualização para o servidor
        async function sendUpdateToServer(pessoa, carro, acao) {
            await fetch('/api/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pessoa, carro, acao })
            });
        }
        
        // Função chamada pelos botões de ocupação
        function tryToOccupy(novaPessoa, novoCarro) {
            if (currentStatus.status === 'LIVRE') {
                // ATUALIZAÇÃO OTIMISTA: Atualiza a tela localmente na hora
                updateStatusDisplay({ status: 'OCUPADA', pessoa: novaPessoa, carro: novoCarro, timestamp: 'agora...' });
                sendUpdateToServer(novaPessoa, novoCarro, 'ENTRADA');
            } else {
                // Abre o modal de aviso se a vaga estiver ocupada
                const warningText = document.getElementById('warning-modal-text');
                warningText.textContent = `Vaga ocupada por ${currentStatus.pessoa}. Deseja continuar?`;
                
                const forceButton = document.getElementById('force-occupy-btn');
                forceButton.onclick = () => forceOccupy(novaPessoa, novoCarro);
                openWarningModal();
            }
        }
        
        // Função para forçar a ocupação
        function forceOccupy(novaPessoa, novoCarro) {
            // ATUALIZAÇÃO OTIMISTA: Mostra o resultado final na hora
            updateStatusDisplay({ status: 'OCUPADA', pessoa: novaPessoa, carro: novoCarro, timestamp: 'agora...' });
            
            // Envia os dois comandos em sequência para o servidor
            sendUpdateToServer(novaPessoa, currentStatus.carro, 'SAIDA');
            sendUpdateToServer(novaPessoa, novoCarro, 'ENTRADA');
            
            closeWarningModal();
        }
        
        // Funções dos modais
        function openSaidaModal() { saidaModal.style.display = 'flex'; }
        function closeSaidaModal() { saidaModal.style.display = 'none'; }
        
        function confirmarSaida(pessoa) {
             // ATUALIZAÇÃO OTIMISTA
            updateStatusDisplay({ status: 'LIVRE', pessoa: pessoa, carro: 'Nenhum', timestamp: 'agora...' });
            sendUpdateToServer(pessoa, 'Qualquer', 'SAIDA');
            closeSaidaModal();
        }

        function openWarningModal() { warningModal.style.display = 'flex'; }
        function closeWarningModal() { warningModal.style.display = 'none'; }


        // --- LÓGICA DE CONEXÃO E ATUALIZAÇÃO EM TEMPO REAL ---

        // 1. Busca o status inicial ao carregar a página
        fetch('/api/status').then(res => res.json()).then(data => {
            updateStatusDisplay(data);
        }).catch(err => console.error("Erro no fetch inicial:", err));

        // 2. Conecta ao stream de eventos do servidor para atualizações em tempo real
        const eventSource = new EventSource("/api/stream");
        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            updateStatusDisplay(data); // Atualiza a tela com a informação oficial do servidor
        };
        eventSource.onerror = function(err) {
            console.error("Erro na conexão EventSource:", err);
        };
    </script>
    
    <script>
        // --- LÓGICA DE PWA E NOTIFICAÇÕES (sem alterações) ---
        const notificationsBtn = document.getElementById('notifications-btn');
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/service-worker.js')
                .then(() => console.log('Service Worker registrado com sucesso.'))
                .catch(error => console.error('Falha ao registrar Service Worker:', error));
        } else {
            notificationsBtn.style.display = 'none';
        }
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) { outputArray[i] = rawData.charCodeAt(i); }
            return outputArray;
        }
        async function subscribeUser() {
            try {
                const response = await fetch('/api/vapid_public_key');
                const data = await response.json();
                const convertedVapidKey = urlBase64ToUint8Array(data.public_key);
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: convertedVapidKey
                });
                await fetch('/api/subscribe', {
                    method: 'POST',
                    body: JSON.stringify(subscription),
                    headers: { 'Content-Type': 'application/json' }
                });
                notificationsBtn.textContent = 'Notificações Ativadas!';
                notificationsBtn.disabled = true;
            } catch (error) {
                console.error('Falha ao se inscrever para notificações:', error);
                alert('Não foi possível ativar as notificações.');
            }
        }
        notificationsBtn.addEventListener('click', () => {
            if (Notification.permission === 'denied') {
                alert('As notificações foram bloqueadas. Você precisa habilitá-las nas configurações do seu navegador ou site.');
                return;
            }
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    subscribeUser();
                }
            });
        });
    </script>
</body>
</html>