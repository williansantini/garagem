<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status da Garagem</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#007bff"/>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f0f0f0; padding: 10px; }
        #status-box { margin-top: 20px; padding: 30px; border-radius: 10px; text-align: center; color: white; width: 90%; max-width: 400px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .ocupada { background-color: #dc3545; }
        .livre { background-color: #28a745; }
        h1 { margin: 0; font-size: 1.8em; }
        p { margin-top: 5px; font-size: 0.9em; }
        #actions { margin-top: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 500px;}
        button { padding: 20px; font-size: 1em; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.1s ease; }
        button:active { transform: scale(0.95); }
        .eu-audi { background-color: #007bff; color: white; }
        .angelica-audi { background-color: #17a2b8; color: white; }
        .angelica-fit { background-color: #ffc107; color: black; }
        .nicolas-fit { background-color: #6c757d; color: white; }
        .saida { background-color: #fd7e14; color: white; grid-column: 1 / -1; }
    </style>
</head>
<body>

    <div id="status-box">
        <h1 id="status-text">Carregando...</h1>
        <p id="status-details"></p>
    </div>

    <div id="actions">
        <button class="eu-audi" onclick="tryToOccupy('Willian', 'Audi')">Willian (Audi)</button>
        <button class="nicolas-fit" onclick="tryToOccupy('Nicolas', 'Fit')">Nicolas (Fit)</button>
        <button class="angelica-audi" onclick="tryToOccupy('Angelica', 'Audi')">Angelica (Audi)</button>
        <button class="angelica-fit" onclick="tryToOccupy('Angelica', 'Fit')">Angelica (Fit)</button>
        <button class="saida" onclick="update('Sistema', 'Qualquer', 'SAIDA')">Liberei a Garagem</button>
    </div>

    <div style="margin-top: 20px; text-align: center;">
        <button id="notifications-btn" style="padding: 15px; font-size: 1em; background-color: #333; color: white; border: none; border-radius: 8px;">
            Ativar Notificações
        </button>
    </div>

    <script>
        const statusBox = document.getElementById('status-box');
        const statusText = document.getElementById('status-text');
        const statusDetails = document.getElementById('status-details');

        function updateStatusDisplay(data) {
            statusText.textContent = `GARAGEM ${data.status}`;
            if (data.status === 'OCUPADA') {
                statusDetails.textContent = `Por ${data.pessoa} com o ${data.carro} desde ${data.timestamp}`;
                statusBox.className = 'ocupada';
            } else {
                statusDetails.textContent = `Liberada por último por ${data.pessoa} em ${data.timestamp}`;
                statusBox.className = 'livre';
            }
        }

        async function update(pessoa, carro, acao) {
            // Apenas envia a requisição. A atualização visual virá via SSE.
            await fetch('/api/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pessoa, carro, acao })
            });
        }
        
        // Esta função agora precisa buscar o status atual antes de agir
        async function tryToOccupy(novaPessoa, novoCarro) {
            const response = await fetch('/api/status');
            const currentStatus = await response.json();

            if (currentStatus.status === 'LIVRE') {
                update(novaPessoa, novoCarro, 'ENTRADA');
            } else {
                if (confirm(`A vaga já está ocupada por ${currentStatus.pessoa}. Deseja forçar a entrada? Isso irá registrar a saída dele(a) e a sua entrada.`)) {
                    // Primeiro, registra a saída do ocupante anterior, mas atribuindo a ação a quem está chegando
                    await update(novaPessoa, currentStatus.carro, 'SAIDA');
                    // Em seguida, registra a entrada do novo ocupante
                    await update(novaPessoa, novoCarro, 'ENTRADA');
                }
            }
        }

        // --- LÓGICA DE CONEXÃO E ATUALIZAÇÃO EM TEMPO REAL ---

        // 1. Busca o status inicial ao carregar a página
        fetch('/api/status').then(res => res.json()).then(data => {
            updateStatusDisplay(data);
        }).catch(err => console.error("Erro no fetch inicial:", err));

        // 2. Conecta ao stream de eventos do servidor para atualizações em tempo real
        const eventSource = new EventSource("/api/stream");
        eventSource.onmessage = function(event) {
            console.log("Novo status recebido via SSE:", event.data);
            const data = JSON.parse(event.data);
            updateStatusDisplay(data);
        };
        eventSource.onerror = function(err) {
            console.error("Erro na conexão EventSource:", err);
        };
    </script>
    
    <script>
        // --- LÓGICA DE PWA E NOTIFICAÇÕES ---
        const notificationsBtn = document.getElementById('notifications-btn');

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/service-worker.js')
                .then(() => console.log('Service Worker registrado com sucesso.'))
                .catch(error => console.error('Falha ao registrar Service Worker:', error));
        } else {
            notificationsBtn.style.display = 'none';
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) { outputArray[i] = rawData.charCodeAt(i); }
            return outputArray;
        }

        async function subscribeUser() {
            try {
                const response = await fetch('/api/vapid_public_key');
                const data = await response.json();
                const convertedVapidKey = urlBase64ToUint8Array(data.public_key);

                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: convertedVapidKey
                });

                await fetch('/api/subscribe', {
                    method: 'POST',
                    body: JSON.stringify(subscription),
                    headers: { 'Content-Type': 'application/json' }
                });

                notificationsBtn.textContent = 'Notificações Ativadas!';
                notificationsBtn.disabled = true;
            } catch (error) {
                console.error('Falha ao se inscrever para notificações:', error);
                alert('Não foi possível ativar as notificações.');
            }
        }
        
        notificationsBtn.addEventListener('click', () => {
            if (Notification.permission === 'denied') {
                alert('As notificações foram bloqueadas. Você precisa habilitá-las nas configurações do seu navegador ou site.');
                return;
            }
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    subscribeUser();
                }
            });
        });
    </script>
</body>
</html>