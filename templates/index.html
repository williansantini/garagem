<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Status da Garagem</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#1c1c1e"/>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div id="status-box">
        <h1 id="status-text"></h1>
        <p id="status-details"></p>
    </div>

    <div id="feira-aviso" style="display: none;">
        <p id="feira-aviso-text"></p>
    </div>

    <div id="actions">
        <button class="eu-audi" onclick="tryToOccupy('Willian', 'Audi')">Willian (Berog)</button>
        <button class="nicolas-fit" onclick="tryToOccupy('Nicolas', 'Fit')">Nicolas (Fit)</button>
        <button class="angelica-audi" onclick="tryToOccupy('Angelica', 'Audi')">Angelica (Berog)</button>
        <button class="angelica-fit" onclick="tryToOccupy('Angelica', 'Fit')">Angelica (Fit)</button>
        <button class="saida" id="free-garage-btn" onclick="openSaidaModal()"></button>
    </div>

    <div id="saida-modal" class="modal-overlay" onclick="closeSaidaModal()"><div class="modal-content" onclick="event.stopPropagation();">
        <h3 id="who-is-leaving-text"></h3>
        <div class="modal-actions">
            <button class="eu-audi" onclick="confirmarSaida('Willian')">Willian</button>
            <button class="angelica-audi" onclick="confirmarSaida('Angelica')">Angelica</button>
            <button class="nicolas-fit" onclick="confirmarSaida('Nicolas')">Nicolas</button>
            <button class="btn-close" id="cancel-btn-saida" onclick="closeSaidaModal()"></button>
        </div>
    </div></div>
    <div id="warning-modal" class="modal-overlay" onclick="closeWarningModal()"><div class="modal-content" onclick="event.stopPropagation();">
        <h3 id="warning-modal-text"></h3>
        <div class="modal-actions">
            <button id="force-occupy-btn" class="btn-force-occupy"></button>
            <button class="btn-close" id="back-btn-warning" onclick="closeWarningModal()"></button>
        </div>
    </div></div>
    <div style="margin-top: 20px; text-align: center;"><button id="notifications-btn" style="padding: 15px; font-size: 1em; background-color: var(--surface-color); color: var(--primary-text-color); border: none; border-radius: 12px;"></button></div>

    <div id="apod-container" style="display: none;">
        <h4 id="apod-title"></h4>
        <img id="apod-image" src="" alt="Imagem Astronômica do Dia">
        <p id="apod-explanation"></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const statusBox = document.getElementById('status-box');
            const statusText = document.getElementById('status-text');
            const statusDetails = document.getElementById('status-details');
            const saidaModal = document.getElementById('saida-modal');
            const warningModal = document.getElementById('warning-modal');
            let currentStatus = {};
            let lastStatusString = "";
            let strings = {}; // --- FEATURE: EXTERNALIZAR STRINGS (Objeto para armazenar as strings) ---

            // --- FEATURE: EXTERNALIZAR STRINGS ---
            // Função para buscar as strings do servidor
            async function fetchStrings() {
                try {
                    const response = await fetch('/api/strings');
                    strings = await response.json();
                    applyStrings();
                } catch (err) {
                    console.error("Erro ao buscar strings:", err);
                    // Fallback para textos padrão em caso de erro
                    statusText.textContent = 'Carregando...';
                }
            }

            // Função para aplicar as strings nos elementos da página
            function applyStrings() {
                statusText.textContent = strings.status.loading;
                document.getElementById('feira-aviso-text').innerHTML = strings.warnings.marketDay;
                document.getElementById('free-garage-btn').textContent = strings.buttons.freeGarage;
                document.getElementById('who-is-leaving-text').textContent = strings.modals.whoIsLeaving;
                document.getElementById('cancel-btn-saida').textContent = strings.buttons.cancel;
                document.getElementById('force-occupy-btn').textContent = strings.buttons.releaseAndOccupy;
                document.getElementById('back-btn-warning').textContent = strings.buttons.back;
                document.getElementById('notifications-btn').textContent = strings.buttons.activateNotifications;
            }
            // --- FIM DA FEATURE ---

            window.updateStatusDisplay = function(data) {
                const newStatusString = JSON.stringify(data);
                if (newStatusString === lastStatusString) return; 
                lastStatusString = newStatusString;

                currentStatus = data;
                // --- FEATURE: EXTERNALIZAR STRINGS ---
                statusText.textContent = strings.status.garageStatus.replace('{status}', data.status);
                if (data.status === 'OCUPADA') {
                    statusDetails.textContent = strings.status.occupiedBy
                        .replace('{person}', data.pessoa)
                        .replace('{car}', data.carro)
                        .replace('{timestamp}', data.timestamp);
                    statusBox.className = 'ocupada';
                } else {
                    statusDetails.textContent = strings.status.vacantLastFreedBy
                        .replace('{person}', data.pessoa)
                        .replace('{timestamp}', data.timestamp);
                    statusBox.className = 'livre';
                }
                // --- FIM DA FEATURE ---
            }

            async function sendUpdateToServer(pessoa, carro, acao) {
                await fetch('/api/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pessoa, carro, acao })
                });
                fetchLatestStatus();
            }
            
            window.tryToOccupy = function(novaPessoa, novoCarro) {
                if (currentStatus.status === 'LIVRE' || !currentStatus.status) {
                    sendUpdateToServer(novaPessoa, novoCarro, 'ENTRADA');
                } else {
                    const warningText = document.getElementById('warning-modal-text');
                    // --- FEATURE: EXTERNALIZAR STRINGS ---
                    warningText.textContent = strings.warnings.occupiedBySomeone.replace('{person}', currentStatus.pessoa);
                    // --- FIM DA FEATURE ---
                    const forceButton = document.getElementById('force-occupy-btn');
                    forceButton.onclick = () => forceOccupy(novaPessoa, novoCarro);
                    openWarningModal();
                }
            }
            
            function forceOccupy(novaPessoa, novoCarro) {
                sendUpdateToServer(currentStatus.pessoa, currentStatus.carro, 'SAIDA');
                setTimeout(() => {
                    sendUpdateToServer(novaPessoa, novoCarro, 'ENTRADA');
                }, 250);
                closeWarningModal();
            }
            
            window.openSaidaModal = function() { saidaModal.style.display = 'flex'; }
            window.closeSaidaModal = function() { saidaModal.style.display = 'none'; }
            
            window.confirmarSaida = function(pessoa) {
                sendUpdateToServer(pessoa, 'Qualquer', 'SAIDA');
                closeSaidaModal();
            }

            window.openWarningModal = function() { warningModal.style.display = 'flex'; }
            window.closeWarningModal = function() { warningModal.style.display = 'none'; }

            async function fetchLatestStatus() {
                try {
                    const response = await fetch('/api/status');
                    if (!response.ok) return;
                    const data = await response.json();
                    updateStatusDisplay(data);
                } catch (err) {
                    console.error("Erro ao buscar status:", err);
                }
            }
            
            function verificarDiaDaFeira() {
                const hoje = new Date();
                const diaDaSemana = hoje.getDay(); 
                const horaAtual = hoje.getHours(); 

                if (diaDaSemana === 4 || (diaDaSemana === 5 && horaAtual < 12)) {
                    document.getElementById('feira-aviso').style.display = 'block';
                }
            }
            
            async function fetchApod() {
                try {
                    const response = await fetch('/api/apod');
                    if (!response.ok) return;
                    const data = await response.json();
                    
                    if (data.media_type === 'image') {
                        document.getElementById('apod-container').style.display = 'block';
                        document.getElementById('apod-title').textContent = data.title;
                        document.getElementById('apod-image').src = data.url;
                        
                        const explanationP = document.getElementById('apod-explanation');
                        explanationP.textContent = data.explanation + ' '; 
                        
                        const hdLink = document.createElement('a');
                        hdLink.href = data.hdurl || data.url;
                        // --- FEATURE: EXTERNALIZAR STRINGS ---
                        hdLink.textContent = strings.apod.viewInHd;
                        // --- FIM DA FEATURE ---
                        hdLink.target = '_blank';
                        
                        explanationP.appendChild(hdLink);
                    }

                } catch (err) {
                    console.error("Erro ao buscar APOD:", err);
                }
            }
            
            // --- FEATURE: EXTERNALIZAR STRINGS ---
            await fetchStrings(); // Carrega as strings antes de qualquer outra coisa
            // --- FIM DA FEATURE ---
            
            verificarDiaDaFeira();
            fetchLatestStatus();
            fetchApod(); 
            setInterval(fetchLatestStatus, 5000);

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') fetchLatestStatus();
            });

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js').catch(err => console.error('Erro SW:', err));
            } else {
                document.getElementById('notifications-btn').style.display = 'none';
            }
        });
    </script>
    <script>
      const notificationsBtn = document.getElementById('notifications-btn');
      function urlBase64ToUint8Array(base64String) {
          const padding = '='.repeat((4 - base64String.length % 4) % 4);
          const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
          const rawData = window.atob(base64);
          const outputArray = new Uint8Array(rawData.length);
          for (let i = 0; i < rawData.length; ++i) { outputArray[i] = rawData.charCodeAt(i); }
          return outputArray;
      }
      async function subscribeUser() {
          try {
              const strResponse = await fetch('/api/strings'); // --- FEATURE: EXTERNALIZAR STRINGS ---
              const strings = await strResponse.json(); // --- FEATURE: EXTERNALIZAR STRINGS ---
              const response = await fetch('/api/vapid_public_key');
              const data = await response.json();
              const convertedVapidKey = urlBase64ToUint8Array(data.public_key);
              const registration = await navigator.serviceWorker.ready;
              const subscription = await registration.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: convertedVapidKey });
              await fetch('/api/subscribe', { method: 'POST', body: JSON.stringify(subscription), headers: { 'Content-Type': 'application/json' } });
              notificationsBtn.textContent = strings.buttons.notificationsActivated; // --- FEATURE: EXTERNALIZAR STRINGS ---
              notificationsBtn.disabled = true;
          } catch (error) {
              console.error('Falha ao se inscrever:', error);
              alert(strings.warnings.notificationsFailed); // --- FEATURE: EXTERNALIZAR STRINGS ---
          }
      }
      notificationsBtn.addEventListener('click', async () => {
          // --- FEATURE: EXTERNALIZAR STRINGS ---
          const strResponse = await fetch('/api/strings');
          const strings = await strResponse.json();
          if (Notification.permission === 'denied') { 
              alert(strings.warnings.notificationsBlocked); 
              return; 
          }
          // --- FIM DA FEATURE ---
          Notification.requestPermission().then(permission => { if (permission === 'granted') { subscribeUser(); } });
      });
    </script>
</body>
</html>