<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Status da Garagem</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#1c1c1e"/>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
</head>
<body>
    <div id="status-box">
        <img id="status-icon" src="" alt="Ícone de Status">
        <div id="status-text-container">
            <h1 id="status-text"></h1>
            <p id="status-details"></p>
        </div>
    </div>

    <div id="feira-aviso" style="display: none;">
        <p id="feira-aviso-text"></p>
    </div>

    <div id="actions">
        <button class="eu-audi" onclick="tryToOccupy('Willian', 'o Berog')">Willian (Berog)</button>
        <button class="nicolas-fit" onclick="tryToOccupy('Nicolas', 'a Fit')">Nicolas (Fit)</button>
        <button class="angelica-audi" onclick="tryToOccupy('Angelica', 'o Berog')">Angelica (Berog)</button>
        <button class="angelica-fit" onclick="tryToOccupy('Angelica', 'a Fit')">Angelica (Fit)</button>
        <button class="saida" id="free-garage-btn" onclick="openSaidaModal()"></button>
    </div>

    <div id="saida-modal" class="modal-overlay" onclick="closeSaidaModal()"><div class="modal-content" onclick="event.stopPropagation();">
        <h3 id="who-is-leaving-text"></h3>
        <div class="modal-actions">
            <button class="eu-audi" onclick="confirmarSaida('Willian')">Willian</button>
            <button class="angelica-audi" onclick="confirmarSaida('Angelica')">Angelica</button>
            <button class="nicolas-fit" onclick="confirmarSaida('Nicolas')">Nicolas</button>
            <button class="btn-close" id="cancel-btn-saida" onclick="closeSaidaModal()"></button>
        </div>
    </div></div>
    <div id="warning-modal" class="modal-overlay" onclick="closeWarningModal()"><div class="modal-content" onclick="event.stopPropagation();">
        <h3 id="warning-modal-text"></h3>
        <div class="modal-actions">
            <button id="force-occupy-btn" class="btn-force-occupy"></button>
            <button class="btn-close" id="back-btn-warning" onclick="closeWarningModal()"></button>
        </div>
    </div></div>
    <div style="margin-top: 20px; text-align: center;"><button id="notifications-btn" style="padding: 15px; font-size: 1em; background-color: var(--surface-color); color: var(--primary-text-color); border: none; border-radius: 12px;"></button></div>

    <div id="apod-container" style="display: none;">
        <h4 id="apod-title"></h4>
        <img id="apod-image" src="" alt="Imagem Astronômica do Dia">
        <p id="apod-explanation"></p>
    </div>

    <div id="gamification-overlay-vacant" class="gamification-overlay hidden">
        <img id="gamification-cat-vacant" src="/static/confetti_cat.jpg" alt="Gato comemorando!">
    </div>
    <div id="gamification-overlay-occupied" class="gamification-overlay hidden">
        <img id="gamification-cat-occupied" src="/static/dosto_ocupado.jpg" alt="Gato Feliz!">
    </div>


    <script>
        // Variável `strings` no escopo global para ser acessível por ambos os scripts.
        let strings = {}; 
        
        document.addEventListener('DOMContentLoaded', async () => {
            const statusBox = document.getElementById('status-box');
            const statusText = document.getElementById('status-text');
            const statusDetails = document.getElementById('status-details');
            const saidaModal = document.getElementById('saida-modal');
            const warningModal = document.getElementById('warning-modal');
            const statusIcon = document.getElementById('status-icon');
            
            // --- Elementos da Gamificação ---
            const vacantGamificationOverlay = document.getElementById('gamification-overlay-vacant');
            const occupiedGamificationOverlay = document.getElementById('gamification-overlay-occupied');
            let vacantGamificationTimeout;
            let occupiedGamificationTimeout;
            // --- Fim dos Elementos ---

            let currentStatus = {};
            let lastStatusString = "";

            async function fetchStrings() {
                try {
                    const response = await fetch('/api/strings');
                    strings = await response.json();
                    applyStrings();
                } catch (err) {
                    console.error("Erro ao buscar strings:", err);
                    statusText.textContent = 'Carregando...';
                }
            }
            
            function applyStrings() {
                statusText.textContent = strings.status.loading;
                document.getElementById('feira-aviso-text').innerHTML = strings.warnings.marketDay;
                document.getElementById('free-garage-btn').textContent = strings.buttons.freeGarage;
                document.getElementById('who-is-leaving-text').textContent = strings.modals.whoIsLeaving;
                document.getElementById('cancel-btn-saida').textContent = strings.buttons.cancel;
                document.getElementById('force-occupy-btn').textContent = strings.buttons.releaseAndOccupy;
                document.getElementById('back-btn-warning').textContent = strings.buttons.back;
            }

            // --- FUNÇÕES DA NOVA FEATURE DE GAMIFICAÇÃO ---
            function hideVacantGamification() {
                clearTimeout(vacantGamificationTimeout);
                vacantGamificationOverlay.classList.add('hidden');
            }

            function showVacantGamification() {
                if (!vacantGamificationOverlay.classList.contains('hidden')) return;
                vacantGamificationOverlay.classList.remove('hidden');
                confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
                vacantGamificationTimeout = setTimeout(hideVacantGamification, 2000);
            }

            function hideOccupiedGamification() {
                clearTimeout(occupiedGamificationTimeout);
                occupiedGamificationOverlay.classList.add('hidden');
            }

            function showOccupiedGamification() {
                if (!occupiedGamificationOverlay.classList.contains('hidden')) return;
                occupiedGamificationOverlay.classList.remove('hidden');
                // Efeito visual de "fogo" ou "faíscas" para o gato bravo
                 confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#ff453a', '#ff9f0a', '#ffd60a']
                });
                occupiedGamificationTimeout = setTimeout(hideOccupiedGamification, 2000);
            }

            // Adiciona eventos de clique para fechar
            vacantGamificationOverlay.addEventListener('click', hideVacantGamification);
            occupiedGamificationOverlay.addEventListener('click', hideOccupiedGamification);
            // --- FIM DAS FUNÇÕES ---


            window.updateStatusDisplay = function(data) {
                const newStatusString = JSON.stringify(data);
                if (newStatusString === lastStatusString) return; 

                // --- LÓGICA PARA DISPARAR A FEATURE ---
                if (currentStatus.status === 'OCUPADA' && data.status !== 'OCUPADA') {
                    showVacantGamification();
                } else if (currentStatus.status === 'LIVRE' && data.status === 'OCUPADA') {
                    showOccupiedGamification();
                }
                // --- FIM DA LÓGICA ---

                lastStatusString = newStatusString;
                currentStatus = data;
                statusText.textContent = strings.status.garageStatus.replace('{status}', data.status);

                if (data.status === 'OCUPADA') {
                    statusDetails.textContent = strings.status.occupiedBy
                        .replace('{person}', data.pessoa)
                        .replace('{car}', data.carro)
                        .replace('{timestamp}', data.timestamp);
                    statusBox.className = 'ocupada';
                    statusIcon.src = '/static/gato_ocupado.jpg';
                } else {
                    statusDetails.textContent = strings.status.vacantLastFreedBy
                        .replace('{person}', data.pessoa)
                        .replace('{timestamp}', data.timestamp);
                    statusBox.className = 'livre';
                    statusIcon.src = '/static/gato_livre.jpg';
                }
            }

            async function sendUpdateToServer(pessoa, carro, acao) {
                await fetch('/api/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pessoa, carro, acao })
                });
                fetchLatestStatus();
            }
            
            window.tryToOccupy = function(novaPessoa, novoCarro) {
                if (currentStatus.status === 'LIVRE' || !currentStatus.status) {
                    sendUpdateToServer(novaPessoa, novoCarro, 'ENTRADA');
                } else {
                    const warningText = document.getElementById('warning-modal-text');
                    warningText.textContent = strings.warnings.occupiedBySomeone.replace('{person}', currentStatus.pessoa);
                    const forceButton = document.getElementById('force-occupy-btn');
                    forceButton.onclick = () => forceOccupy(novaPessoa, novoCarro);
                    openWarningModal();
                }
            }
            
            function forceOccupy(novaPessoa, novoCarro) {
                sendUpdateToServer(currentStatus.pessoa, currentStatus.carro, 'SAIDA');
                setTimeout(() => {
                    sendUpdateToServer(novaPessoa, novoCarro, 'ENTRADA');
                }, 250);
                closeWarningModal();
            }
            
            window.openSaidaModal = function() { saidaModal.style.display = 'flex'; }
            window.closeSaidaModal = function() { saidaModal.style.display = 'none'; }
            
            window.confirmarSaida = function(pessoa) {
                sendUpdateToServer(pessoa, 'Qualquer', 'SAIDA');
                closeSaidaModal();
            }

            window.openWarningModal = function() { warningModal.style.display = 'flex'; }
            window.closeWarningModal = function() { warningModal.style.display = 'none'; }

            async function fetchLatestStatus() {
                try {
                    const response = await fetch('/api/status');
                    if (!response.ok) return;
                    const data = await response.json();
                    updateStatusDisplay(data);
                } catch (err) {
                    console.error("Erro ao buscar status:", err);
                }
            }
            
            function verificarDiaDaFeira() {
                const hoje = new Date();
                const diaDaSemana = hoje.getDay(); 
                const horaAtual = hoje.getHours(); 

                if (diaDaSemana === 4 || (diaDaSemana === 5 && horaAtual < 12)) {
                    document.getElementById('feira-aviso').style.display = 'block';
                }
            }
            
            async function fetchApod() {
                try {
                    const response = await fetch('/api/apod');
                    if (!response.ok) return;
                    const data = await response.json();
                    
                    if (data.media_type === 'image') {
                        document.getElementById('apod-container').style.display = 'block';
                        document.getElementById('apod-title').textContent = data.title;
                        document.getElementById('apod-image').src = data.url;
                        
                        const explanationP = document.getElementById('apod-explanation');
                        explanationP.textContent = data.explanation + ' '; 
                        
                        const hdLink = document.createElement('a');
                        hdLink.href = data.hdurl || data.url;
                        hdLink.textContent = strings.apod.viewInHd;
                        hdLink.target = '_blank';
                        
                        explanationP.appendChild(hdLink);
                    }

                } catch (err) {
                    console.error("Erro ao buscar APOD:", err);
                }
            }
            
            await fetchStrings(); 
            
            verificarDiaDaFeira();
            fetchLatestStatus();
            fetchApod(); 
            setInterval(fetchLatestStatus, 5000);

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') fetchLatestStatus();
            });
        });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Aguarda a variável global `strings` ser populada
        while (typeof strings === 'undefined' || Object.keys(strings).length === 0) {
            await new Promise(resolve => setTimeout(resolve, 100));
        }

        const notificationsBtn = document.getElementById('notifications-btn');
        if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
            notificationsBtn.style.display = 'none';
            return;
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) { outputArray[i] = rawData.charCodeAt(i); }
            return outputArray;
        }

        async function updateButtonUI() {
            const registration = await navigator.serviceWorker.ready;
            const subscription = await registration.pushManager.getSubscription();
            
            if (Notification.permission === 'denied') {
                notificationsBtn.textContent = strings.warnings.notificationsBlocked;
                notificationsBtn.disabled = true;
            } else if (subscription) {
                notificationsBtn.textContent = strings.buttons.disableNotifications;
                notificationsBtn.disabled = false;
            } else {
                notificationsBtn.textContent = strings.buttons.activateNotifications;
                notificationsBtn.disabled = false;
            }
        }
        
        async function subscribeUser() {
            try {
                const response = await fetch('/api/vapid_public_key');
                const data = await response.json();
                const convertedVapidKey = urlBase64ToUint8Array(data.public_key);
                const registration = await navigator.serviceWorker.ready;
                
                const subscription = await registration.pushManager.subscribe({ 
                    userVisibleOnly: true, 
                    applicationServerKey: convertedVapidKey 
                });

                await fetch('/api/subscribe', { 
                    method: 'POST', 
                    body: JSON.stringify(subscription), 
                    headers: { 'Content-Type': 'application/json' } 
                });

                notificationsBtn.textContent = strings.buttons.notificationsActivated;
                setTimeout(updateButtonUI, 1500);

            } catch (error) {
                console.error('Falha ao se inscrever:', error);
                if (Notification.permission !== 'denied') {
                  alert(strings.warnings.notificationsFailed);
                }
                updateButtonUI();
            }
        }

        async function unsubscribeUser() {
            try {
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.getSubscription();

                if (subscription) {
                    const unsubscribed = await subscription.unsubscribe();
                    if (unsubscribed) {
                        await fetch('/api/unsubscribe', {
                            method: 'POST',
                            body: JSON.stringify(subscription),
                            headers: { 'Content-Type': 'application/json' }
                        });
                    }
                    notificationsBtn.textContent = strings.buttons.notificationsDeactivated;
                    setTimeout(updateButtonUI, 1500);
                }
            } catch (error) {
                console.error('Falha ao se desinscrever:', error);
                alert(strings.warnings.deactivationFailed);
                updateButtonUI();
            }
        }

        notificationsBtn.addEventListener('click', async () => {
            const registration = await navigator.serviceWorker.ready;
            const subscription = await registration.pushManager.getSubscription();

            if (subscription) {
                await unsubscribeUser();
            } else {
                if (Notification.permission === 'denied') {
                    alert(strings.warnings.notificationsBlocked);
                    return;
                }
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    await subscribeUser();
                } else {
                   await updateButtonUI();
                }
            }
        });

        // Inicializa o Service Worker e a UI do botão
        try {
            await navigator.serviceWorker.register('/service-worker.js');
            await updateButtonUI();
        } catch (err) {
            console.error('Erro SW:', err)
            notificationsBtn.style.display = 'none';
        }
    });
    </script>
</body>
</html>